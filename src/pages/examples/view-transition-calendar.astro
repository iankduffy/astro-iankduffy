---
import Layout from '../../layouts/Layout.astro';
---

<Layout title='Calendar View Transition'>
	<main class='layout'>
		<h1>Calendar View Transition</h1>
		<calendar-element>
			<header class='header'>
				<button data-nav='previous'>Previous</button>
				<button data-nav='next'>Next</button>
			</header>
			<main>
				<p>Loading...</p>
			</main>
		</calendar-element>
	</main>
</Layout>

<script is:inline>
	class CalendarElement extends HTMLElement {
		constructor() {
			super();
		}

		async connectedCallback() {
			this.currentDate = new Date();
			this.currentDate.setDate(1); // Set to 1st day of month
			// this.currentDate.setHours(0);
			this.calendercontainer = this.querySelector('main');
			this.buttons = this.querySelectorAll('button[data-nav]');

			// Dynamically import date-fns
			const dateFns = await import(
				'https://cdn.jsdelivr.net/npm/date-fns@3.3.1/+esm'
			);
			this.dateFns = dateFns;

			this.updateCalendar();
			this.setUpEventListner();
		}

		setUpEventListner() {
			this.buttons.forEach((button) => {
				button.addEventListener('click', () => {
					const direction = button.dataset.nav;
					if (direction === 'next') {
						this.currentDate.setMonth(this.currentDate.getMonth() + 1);
					} else if (direction === 'previous') {
						this.currentDate.setMonth(this.currentDate.getMonth() - 1);
					}
					if (!document.startViewTransition) {
						this.updateCalendar();
						return;
					}
					document.startViewTransition({
						update: () => {
							this.updateCalendar();
						},
						types: [direction],
					});
				});
			});
		}

		updateCalendar() {
			const {
				startOfMonth,
				endOfMonth,
				eachDayOfInterval,
				format,
				startOfWeek,
				endOfWeek,
			} = this.dateFns;

			const monthStart = startOfMonth(this.currentDate);
			const monthEnd = endOfMonth(this.currentDate);

			// Get all days to display (including days from prev/next month to fill grid)
			const calendarStart = startOfWeek(monthStart);
			const calendarEnd = endOfWeek(monthEnd);

			const days = eachDayOfInterval({
				start: calendarStart,
				end: calendarEnd,
			});

			const monthName = format(this.currentDate, 'MMMM yyyy');

			let html = `<h2>${monthName}</h2>`;
			html += '<div class="calendar-grid">';
			html += '<div class="day-header">Sun</div>';
			html += '<div class="day-header">Mon</div>';
			html += '<div class="day-header">Tue</div>';
			html += '<div class="day-header">Wed</div>';
			html += '<div class="day-header">Thu</div>';
			html += '<div class="day-header">Fri</div>';
			html += '<div class="day-header">Sat</div>';

			days.forEach((day) => {
				const isCurrentMonth = day.getMonth() === this.currentDate.getMonth();
				const className = isCurrentMonth ? 'day' : 'day other-month';
				html += `<button class="${className}">${format(day, 'd')}</button>`;
			});

			html += '</div>';
			this.calendercontainer.innerHTML = html;
		}
	}
	customElements.define('calendar-element', CalendarElement);
</script>

<style lang='scss'>
	.layout {
		max-width: 500px;
		margin: 0 auto;
		width: 100%;
		text-align: center;
	}

	.header {
		display: flex;
		justify-content: space-between;

		button {
			border: 1px solid #ddd;
			padding: 16px;
		}
	}
</style>

<style is:inline>
	.calendar-grid {
		display: grid;
		grid-template-columns: repeat(7, 1fr);
		gap: 8px;
		margin-top: 16px;
		view-transition-name: calendar;
		transition: 2s;
		margin: 20px;
	}

	.day-header {
		font-weight: bold;
		text-align: center;
		padding: 8px;
	}

	.day {
		text-align: center;
		padding: 12px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

	.other-month {
		opacity: 0.3;
	}

	@keyframes slide-out-to-left {
		from {
			transform: translateX(0);
		}
		to {
			transform: translateX(-100%);
			opacity: 0;
		}
	}

	@keyframes slide-in-from-right {
		from {
			transform: translateX(100%);
			opacity: 0;
		}
		to {
			transform: translateX(0);
		}
	}

	@keyframes slide-out-to-right {
		from {
			transform: translateX(0);
		}
		to {
			transform: translateX(100%);
			opacity: 0;
		}
	}

	@keyframes slide-in-from-left {
		from {
			transform: translateX(-100%);
			opacity: 0;
		}
		to {
			transform: translateX(0);
		}
	}

	html:active-view-transition-type(next) {
		&::view-transition-old(calendar) {
			animation-name: slide-out-to-left;
			animation-duration: 300ms;
		}
		&::view-transition-new(calendar) {
			animation-name: slide-in-from-right;
			animation-duration: 300ms;
		}
	}

	html:active-view-transition-type(previous) {
		&::view-transition-old(calendar) {
			animation-name: slide-out-to-right;
			animation-duration: 300ms;
		}
		&::view-transition-new(calendar) {
			animation-name: slide-in-from-left;
			animation-duration: 300ms;
		}
	}
</style>
